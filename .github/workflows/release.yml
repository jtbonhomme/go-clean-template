name: Release with Changelog
on:
  push:
    branches:
    - 'master'

jobs:
  bump-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.create_version_push_tag.outputs.tag }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Semantic Release
        id: semantic_release
        uses: cycjimmy/semantic-release-action@v3
        with:
          semantic_version: 19.0.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Do something when a new release published
        if: steps.semantic_release.outputs.new_release_published == 'true'
        run: |
          echo ${{ steps.semantic_release.outputs.new_release_version }}
          echo ${{ steps.semantic_release.outputs.new_release_major_version }}
          echo ${{ steps.semantic_release.outputs.new_release_minor_version }}
          echo ${{ steps.semantic_release.outputs.new_release_patch_version }}

      - name: Bump version and push tag
        id: create_version_push_tag
        uses: anothrNick/github-tag-action@1.61.0 # Don't use @master unless you're happy to test the latest version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          VERBOSE: true

      - run: |
          echo "created anothrNick new_tag ${{ steps.create_version_push_tag.outputs.new_tag }}"
          echo "created anothrNick tag ${{ steps.create_version_push_tag.outputs.tag }}"
          echo "created anothrNick part ${{ steps.create_version_push_tag.outputs.part }}"

      #- name: "Create latest tag"
      #  id: create_latest_tag
      #  uses: rickstaa/action-create-tag@v1
      #  with:
      #    tag: "latest"
      #    message: "Latest release"
      #    force_push_tag: true

  release-note:
    runs-on: ubuntu-latest
    needs: [bump-tag]
    if: needs.bump-tag.result == 'success'
    steps:

      - name: "Retrieve ref tag"
        id: retrieve_ref_tag
        run: |
          echo "TAG_REF=refs/tags/${{ needs.bump-tag.outputs.tag }}"
          echo "TAG_REF=refs/tags/${{ needs.bump-tag.outputs.tag }}" >> $GITHUB_ENV

      - name: "Checkout"
        if:  env.TAG_REF != null
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ env.TAG_REF }}

      - name: "Build Changelog"
        id: changelog_release
        uses: mikepenz/release-changelog-builder-action@v3.6.0
        with:
          configurationJson: |
            {
                "categories": [
                    {
                        "title": "## 🚀 Features",
                        "labels": ["feat"]
                    },
                    {
                        "title": "## 🐛 Fixes",
                        "labels": ["fix"]
                    },
                    {
                        "title": "## 🧪 Tests",
                        "labels": ["test"]
                    },
                    {
                        "title": "## 💬 Infra",
                        "labels": ["chore"]
                    },
                    {
                        "title": "## 📦 Dependencies",
                        "labels": ["dep"]
                    },
                    {
                        "title": "## 📦 Uncategorized",
                        "labels": []
                    }
                ],
                "max_pull_requests": 200,
                "max_back_track_time_days": 200
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - run: echo "github.ref ${{ github.ref }}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.bump-tag.outputs.tag }}
          body: ${{steps.changelog_release.outputs.changelog}}
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-b') || contains(github.ref, '-a') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
