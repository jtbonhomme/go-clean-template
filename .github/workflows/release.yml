name: Release with Changelog
on:
  push:
    branches:
    - 'master'

jobs:
  bump-tag:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        id: create-version-push-tag
        uses: anothrNick/github-tag-action@1.61.0 # Don't use @master unless you're happy to test the latest version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true

      - run: |
          echo "created anothrNick new_tag ${{ steps.create-version-push-tag.outputs.new_tag }}"
          echo "created anothrNick tag ${{ steps.create-version-push-tag.outputs.tag }}"
          echo "created anothrNick part ${{ steps.create-version-push-tag.outputs.part }}"

      #- name: "Create latest tag"
      #  id: create_latest_tag
      #  uses: rickstaa/action-create-tag@v1
      #  with:
      #    tag: "latest"
      #    message: "Latest release"
      #    force_push_tag: true

  release-note:
    runs-on: ubuntu-latest
    needs: [bump-tag]
    if: needs.bump-tag.result == 'success'
    steps:

      - name: "Checkout"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "Build Changelog"
        id: changelog_release
        uses: mikepenz/release-changelog-builder-action@v3.6.0
        with:
          configurationJson: |
            {
                "categories": [
                    {
                        "title": "## ğŸš€ Features",
                        "labels": ["feat"]
                    },
                    {
                        "title": "## ğŸ› Fixes",
                        "labels": ["fix"]
                    },
                    {
                        "title": "## ğŸ§ª Tests",
                        "labels": ["test"]
                    },
                    {
                        "title": "## ğŸ’¬ Infra",
                        "labels": ["chore"]
                    },
                    {
                        "title": "## ğŸ“¦ Dependencies",
                        "labels": ["dep"]
                    },
                    {
                        "title": "## ğŸ“¦ Uncategorized",
                        "labels": []
                    }
                ],
                "max_pull_requests": 200,
                "max_back_track_time_days": 200
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - run: echo "github.ref ${{ github.ref }}"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: ${{steps.changelog_release.outputs.changelog}}
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-b') || contains(github.ref, '-a') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
