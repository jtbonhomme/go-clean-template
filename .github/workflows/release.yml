name: Release with Changelog
on:
  push:
    branches:
    - 'master'

jobs:
  release-note:
    runs-on: ubuntu-latest
    steps:
      - name: "Create tag"
        uses: K-Phoen/semver-release-action@master
        with:
          release_branch: master
          release_strategy: tag
          tag_format: "v%major%.%minor%.%patch%"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Checkout"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "Build Changelog"
        id: changelog_release
        uses: mikepenz/release-changelog-builder-action@v3.6.0
        with:
          configurationJson: |
            {
                "categories": [
                    {
                        "title": "## ğŸš€ Features",
                        "labels": ["feat"]
                    },
                    {
                        "title": "## ğŸ› Fixes",
                        "labels": ["fix"]
                    },
                    {
                        "title": "## ğŸ§ª Tests",
                        "labels": ["test"]
                    },
                    {
                        "title": "## ğŸ’¬ Infra",
                        "labels": ["chore"]
                    },
                    {
                        "title": "## ğŸ“¦ Dependencies",
                        "labels": ["dep"]
                    },
                    {
                        "title": "## ğŸ“¦ Uncategorized",
                        "labels": []
                    }
                ],
                "max_pull_requests": 200,
                "max_back_track_time_days": 200
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: ${{steps.changelog_release.outputs.changelog}}
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-b') || contains(github.ref, '-a') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
